package com.cor.graphx.subscriber

class BlowOutTireSubscriber (sc: SparkContext, graph : Graph[(VertexProperty), (String, String, Long)]) {
  
  var verticesBlowOutTire = ListBuffer[(VertexProperty)]()
  
   def blowOutTire() {
    val filterPressure = graph.subgraph(vpred = (id, attr) => attr.isInstanceOf[MotorbikeEvent] && ((attr.asInstanceOf[MotorbikeEvent].tirePressure1 >= 2 || attr.asInstanceOf[MotorbikeEvent].tirePressure1 <= 1.2) || (attr.asInstanceOf[MotorbikeEvent].tirePressure2 >= 2 || attr.asInstanceOf[MotorbikeEvent].tirePressure2 <= 1.2)))
    val groupMotorbike = filterPressure.vertices.groupBy(attr => attr._2.asInstanceOf[MotorbikeEvent].motorbikeId)
    val groupMotorbikeOrder = groupMotorbike.map(f => (f._1, f._2.toList.sortBy(f => f._2.asInstanceOf[MotorbikeEvent].currentTimestamp))).collect
    verticesBlowOutTire = verticesBlowOutTire ++ groupMotorbikeOrder.flatMap(f => isBlowOutTire(f._2))
    val blowOutTireVertices = sc.parallelize(verticesBlowOutTire).zipWithIndex().map(r => (r._2.asInstanceOf[VertexId], r._1))
    verticesBlowOutTire = verticesBlowOutTire.filter { attr => (System.currentTimeMillis() - attr.currentTimeStamp) < 3000 }
    graphBlowOutTire = Graph(blowOutTireVertices, sc.parallelize(ListBuffer[Edge[(Integer, String, Long)]]()))

  }

  def isBlowOutTire(list: List[(VertexId, VertexProperty)]): ListBuffer[(VertexProperty)] = {
    val logger: Logger = LoggerFactory.getLogger(this.getClass)
    var result = ListBuffer[(VertexProperty)]()
    for (a <- list; b <- list) {
      if (a._2.asInstanceOf[MotorbikeEvent].tirePressure1 >= 2
        && b._2.asInstanceOf[MotorbikeEvent].tirePressure1 <= 1.2
        && (b._2.asInstanceOf[MotorbikeEvent].currentTimestamp - a._2.asInstanceOf[MotorbikeEvent].currentTimestamp) < 5000 && (b._2.asInstanceOf[MotorbikeEvent].currentTimestamp > a._2.asInstanceOf[MotorbikeEvent].currentTimestamp)
        && sc.parallelize(verticesBlowOutTire).filter(attr => attr.asInstanceOf[BlowOutTireEvent].currentTimestamp1 == a._2.asInstanceOf[MotorbikeEvent].currentTimestamp && attr.asInstanceOf[BlowOutTireEvent].currentTimestamp2 == b._2.asInstanceOf[MotorbikeEvent].currentTimestamp).count == 0) {
        val blowOutTireEvent = new BlowOutTireEvent(System.currentTimeMillis(), a._2.asInstanceOf[MotorbikeEvent].motorbikeId, b._2.asInstanceOf[MotorbikeEvent].location, a._2.asInstanceOf[MotorbikeEvent].tirePressure1, a._2.asInstanceOf[MotorbikeEvent].tirePressure2, b._2.asInstanceOf[MotorbikeEvent].location, b._2.asInstanceOf[MotorbikeEvent].tirePressure1, b._2.asInstanceOf[MotorbikeEvent].tirePressure2, a._2.asInstanceOf[MotorbikeEvent].currentTimestamp, b._2.asInstanceOf[MotorbikeEvent].currentTimestamp)
        logger.info(blowOutTireEvent.toString)
        result += blowOutTireEvent
      } else {

        if (a._2.asInstanceOf[MotorbikeEvent].tirePressure2 >= 2
          && b._2.asInstanceOf[MotorbikeEvent].tirePressure2 <= 1.2
          && (b._2.asInstanceOf[MotorbikeEvent].currentTimestamp - a._2.asInstanceOf[MotorbikeEvent].currentTimestamp) < 5000 && (b._2.asInstanceOf[MotorbikeEvent].currentTimestamp > a._2.asInstanceOf[MotorbikeEvent].currentTimestamp)
          && sc.parallelize(verticesBlowOutTire).filter(attr => attr.asInstanceOf[BlowOutTireEvent].currentTimestamp1 == a._2.asInstanceOf[MotorbikeEvent].currentTimestamp && attr.asInstanceOf[BlowOutTireEvent].currentTimestamp2 == b._2.asInstanceOf[MotorbikeEvent].currentTimestamp).count == 0) {
          val blowOutTireEvent = new BlowOutTireEvent(System.currentTimeMillis(), a._2.asInstanceOf[MotorbikeEvent].motorbikeId, b._2.asInstanceOf[MotorbikeEvent].location, a._2.asInstanceOf[MotorbikeEvent].tirePressure1, a._2.asInstanceOf[MotorbikeEvent].tirePressure2, b._2.asInstanceOf[MotorbikeEvent].location, b._2.asInstanceOf[MotorbikeEvent].tirePressure1, b._2.asInstanceOf[MotorbikeEvent].tirePressure2, a._2.asInstanceOf[MotorbikeEvent].currentTimestamp, b._2.asInstanceOf[MotorbikeEvent].currentTimestamp)
          logger.info(blowOutTireEvent.toString)
          result += blowOutTireEvent
        }
      }
    }

    return result
  }

  
}